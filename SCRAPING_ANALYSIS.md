# Jリーグ公式サイト スクレイピング分析

## 調査結果

### 1. JSON-LD構造化データ
- **現状**: Jリーグ公式サイトのトップページ（試合一覧ページ）にはJSON-LDが埋め込まれていない
- **個別試合ページ**: 試合詳細ページにもJSON-LDが見つからない
- **結論**: JSON-LDに頼ることはできない。HTML解析が必須

### 2. HTML構造
- **試合一覧ページ**: `<table>` 要素を使用して試合情報を表示
- **テーブル構成**:
  - ヘッダー行: "スタジアム", "対戦カード", "チケット / データ"
  - 試合行: 複数のセルに分散して情報を配置
  - 情報セル: スコア、チーム名、スタジアム、リンクなど

### 3. 試合情報の抽出方法

#### 3.1 試合一覧ページ（`/match/search/all/all/yokohamafm/`）
**構造**:
```
<tr>
  <td>
    <a href="/match/acle/2025/021201/ticket/">19:02横浜国</a>  <!-- スタジアム・時間 -->
  </td>
  <td>
    <a href="/match/acle/2025/021201/live/">横浜FM vs 上海申花</a>  <!-- 対戦カード -->
  </td>
  <td>...</td>
</tr>
<tr>
  <td><a href="/club/yokohamafm/day/">横浜FM</a></td>  <!-- ホームチーム -->
  <td>1</td>  <!-- スコア（ホーム） -->
  <td>試合終了</td>  <!-- ステータス -->
</tr>
```

**抽出ポイント**:
- 試合詳細ページへのリンク: `a[href*="/match/"]` で `/live/` を含むもの
- URLパターン: `/match/{competition}/{year}/{matchId}/live/`
  - 例: `/match/j1/2025/021501/live/`
  - 例: `/match/acle/2025/021201/live/`
- スコア情報: テーブルセルのテキストから数字を抽出

#### 3.2 試合詳細ページ（`/match/{competition}/{year}/{matchId}/live/`）
**構造**: 複雑なHTMLレイアウト。以下の情報を含む:
- タイトルタグ: `<title>【公式】横浜FMvs上海申花の試合結果・データ...`
- スコア要素: `[class*="score"]` で検出可能
- チーム情報: ページ内に散在
- スタジアム情報: ページ内に散在

**抽出ポイント**:
- タイトルから試合情報を抽出（正規表現で解析）
- 複数のセレクタでフォールバック検索
- スコア、チーム名、スタジアムなどは複数の場所に存在する可能性

### 4. 推奨される実装戦略

#### 段階1: 試合一覧ページから基本情報を取得
1. 試合一覧ページを取得
2. テーブル行をループして試合情報を抽出
3. 試合詳細ページへのリンクを収集
4. 重複排除（同じマッチIDは1回だけ処理）

#### 段階2: 試合詳細ページから詳細情報を取得
1. 各試合詳細ページを取得
2. タイトルから基本情報を抽出
3. 複数のセレクタでスコア、スタジアム、チーム情報を検索
4. 見つからない場合は段階1の情報を使用

#### 段階3: エラーハンドリング
- ネットワークエラー時のリトライ
- タイムアウト処理
- 部分的な失敗時の部分的な成功の記録
- 詳細なエラーログ記録

### 5. セレクタ候補（フォールバック用）

#### スコア抽出用セレクタ
```javascript
const scoreSelectors = [
  '.matchScore__num--home',
  '.matchScore__num.home',
  '.matchData__score--home',
  '[class*="score"][class*="home"]',
  'td:contains("0")',  // 数字を含むセル
];
```

#### チーム名抽出用セレクタ
```javascript
const teamSelectors = [
  '.matchTeam--home .matchTeam__name',
  '.matchTeam.home .matchTeam__name',
  '.team.home .teamName',
  '[class*="team"][class*="home"]',
  'h1',  // タイトルから抽出
];
```

#### スタジアム抽出用セレクタ
```javascript
const stadiumSelectors = [
  '.matchData__stadium',
  '.matchData__place',
  '.matchInfo__stadium',
  '[class*="stadium"]',
  '[class*="venue"]',
];
```

### 6. 実装上の注意点

1. **User-Agent**: ブラウザのUser-Agentを設定して、ボットブロック回避
2. **レート制限**: 複数ページ取得時は適切な遅延を設定
3. **キャッシング**: 取得したデータはDBに保存し、不要な再取得を避ける
4. **エラー処理**: 部分的な失敗も記録し、後で手動修正可能にする
5. **テスト**: 実際のページで定期的にセレクタが有効か確認

### 7. 次のステップ

1. 基本的なスクレイピング関数を実装
2. 試合一覧ページから試合リストを抽出
3. 試合詳細ページから詳細情報を抽出
4. DB保存機能を実装
5. エラーハンドリングとリトライロジックを追加
6. 実際のデータで検証
